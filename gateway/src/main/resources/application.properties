# Cho Spring Boot đọc file .env để lấy các giá trị cấu hình
spring.config.import=optional:classpath:.env[.properties]

# ==============================
# SERVER & APPLICATION
# ==============================
# Các giá trị này sẽ được lấy từ file .env
server.port=${SERVER_PORT}
spring.application.name=${SPRING_APPLICATION_NAME}
spring.main.web-application-type=reactive
#spring.profiles.active=${SPRING_PROFILES_ACTIVE}

# ==============================
# JWT CONFIG
# ==============================
jwt.access-expiration-ms=${JWT_ACCESS_EXPIRATION_MS}
jwt.refresh-expiration-ms=${JWT_REFRESH_EXPIRATION_MS}
jwt.secret-key=${JWT_SECRET_KEY}

# ==============================
# GATEWAY ROUTES
# ==============================
spring.cloud.gateway.routes[0].id=user-service
spring.cloud.gateway.routes[0].uri=${USER_SERVICE_URI}
spring.cloud.gateway.routes[0].predicates[0]=Path=/users/**,/auth/**,/oauth2/**,/login/**

spring.cloud.gateway.routes[1].id=customer-service
spring.cloud.gateway.routes[1].uri=${CUSTOMER_SERVICE_URI}
spring.cloud.gateway.routes[1].predicates[0]=Path=/customers/**,/cart/**,/test-drives/**,/feedback/**,/complaints/**,/charging-stations/**

spring.cloud.gateway.routes[2].id=dealer-service
spring.cloud.gateway.routes[2].uri=${DEALER_SERVICE_URI}
spring.cloud.gateway.routes[2].predicates[0]=Path=/dealers/**
spring.cloud.gateway.routes[2].filters[0]=RewritePath=/dealers/(?<remaining>.*), /${remaining}


spring.cloud.gateway.routes[3].id=inventory-service
spring.cloud.gateway.routes[3].uri=${INVENTORY_SERVICE_URI}
spring.cloud.gateway.routes[3].predicates[0]=Path=/inventory/**
spring.cloud.gateway.routes[3].filters[0]=RewritePath=/inventory/(?<remaining>.*), /${remaining}

# Payment service - route với /payments/** (có rewrite)
spring.cloud.gateway.routes[4].id=payment-service-legacy
spring.cloud.gateway.routes[4].uri=${PAYMENT_SERVICE_URI}
spring.cloud.gateway.routes[4].predicates[0]=Path=/payments/**,/favicon.ico
spring.cloud.gateway.routes[4].filters[0]=RewritePath=/payments/(?<remaining>.*), /${remaining}

# Payment service - route với /api/v1/payments/** (KHÔNG rewrite)
spring.cloud.gateway.routes[11].id=payment-service-api
spring.cloud.gateway.routes[11].uri=${PAYMENT_SERVICE_URI}
spring.cloud.gateway.routes[11].predicates[0]=Path=/api/v1/payments/**

spring.cloud.gateway.routes[5].id=sales-service
spring.cloud.gateway.routes[5].uri=${SALES_SERVICE_URI}

spring.cloud.gateway.routes[5].predicates[0]=Path=/sales/**,/orders/**,/sales-orders/**,/api/v1/sales-orders/**,/sendmail/customer-response/**,/api/v1/sales-orders/b2c/sendmail/**
spring.cloud.gateway.routes[5].filters[0]=RewritePath=/orders(?<remaining>/.*)?$, /sales-orders${remaining}
spring.cloud.gateway.routes[5].filters[1]=RewritePath=/sales(?<remaining>/.*)?$, /sales-orders${remaining}


spring.cloud.gateway.routes[6].id=vehicle-service
spring.cloud.gateway.routes[6].uri=${VEHICLE_SERVICE_URI}
spring.cloud.gateway.routes[6].predicates[0]=Path=/vehicles/**
spring.cloud.gateway.routes[6].filters[0]=RewritePath=/vehicles/(?<remaining>.*), /${remaining}

spring.cloud.gateway.routes[7].id=reporting-service
spring.cloud.gateway.routes[7].uri=${REPORTING_SERVICE_URI}
spring.cloud.gateway.routes[7].predicates[0]=Path=/reporting/**
spring.cloud.gateway.routes[7].filters[0]=RewritePath=/reporting/(?<remaining>.*), /${remaining}

# ROUTE [8] (DÀNH RIÊNG CHO SOCKJS HTTP HANDSHAKE - PHẢI ĐẶT TRƯỚC)
# SockJS sử dụng HTTP requests (như /ws/info) nên cần match trước WebSocket upgrade
spring.cloud.gateway.routes[8].id=sales-service-sockjs
spring.cloud.gateway.routes[8].uri=${SALES_SERVICE_URI}
spring.cloud.gateway.routes[8].predicates[0]=Path=/ws/**
spring.cloud.gateway.routes[8].filters[0]=RemoveRequestHeader=Origin
spring.cloud.gateway.routes[8].order=1

# ROUTE [9] (WEBSOCKET UPGRADE - CHỈ MATCH KHI CÓ HEADER Upgrade: websocket)
spring.cloud.gateway.routes[9].id=sales-service-websocket
spring.cloud.gateway.routes[9].uri=${SALES_SERVICE_WS_URI}
spring.cloud.gateway.routes[9].predicates[0]=Path=/ws/**
spring.cloud.gateway.routes[9].predicates[1]=Header=Upgrade, websocket
spring.cloud.gateway.routes[9].order=2

spring.cloud.gateway.routes[10].id=ai-service
spring.cloud.gateway.routes[10].uri=${AI_SERVICE_URI} 
spring.cloud.gateway.routes[10].predicates[0]=Path=/ai/**
spring.cloud.gateway.routes[10].filters[0]=RewritePath=/ai/(?<remaining>.*), /api/ai/${remaining}
spring.cloud.gateway.routes[10].filters[1]=GuestRateLimit

# ==============================
# GLOBAL CORS (CHO TRÌNH DUYỆT)
# ==============================
app.cors.allowed-origins=${APP_CORS_ALLOWED_ORIGINS}

spring.cloud.gateway.globalcors.cors-configurations.[/**].allowed-origins=${APP_CORS_ALLOWED_ORIGINS}
spring.cloud.gateway.globalcors.cors-configurations.[/**].allowed-methods=*
spring.cloud.gateway.globalcors.cors-configurations.[/**].allowed-headers=*
spring.cloud.gateway.globalcors.cors-configurations.[/**].allow-credentials=true

# ==============================
# GATEWAY ROUTES (UNTIL)
# ==============================

# ==============================
# DEBUG LOGGING
# ==============================
logging.level.org.springframework.web.reactive=DEBUG
logging.level.org.springframework.security=DEBUG
logging.level.org.springframework.cloud.gateway=DEBUG




spring.redis.host=${SPRING_REDIS_HOST:localhost}
spring.redis.port=${SPRING_REDIS_PORT:6379}
spring.redis.database=0

